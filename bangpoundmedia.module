<?php
/**
 * @file
 * Code for the bangpoundmedia feature.
 */

/**
 * Implementation of hook_module_implements_alter().
 */
function bangpoundmedia_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'media_token_to_markup_alter') {
    $group = $implementations['bangpoundmedia'];
    unset($implementations['bangpoundmedia']);
    $implementations['bangpoundmedia'] = $group;
  }
}

/**
 * Implementation of hook_filter_info_alter()
 */
function bangpoundmedia_filter_info_alter(&$info) {
  $info['media_filter']['cache'] = FALSE;
}

/**
 * Implement hook_preprocess_file_entity().
 */
function bangpoundmedia_preprocess_file_entity(&$variables) {
  $elements = $variables['elements'];
  if (isset($elements['#media_filter'])) {
    $variables['attributes_array'] = array_merge($variables['attributes_array'], $elements['#attributes']);
    if (isset($variables['attributes_array']['style'])) {
      $variables['attributes_array']['style'] = preg_replace('|height: ?.+?\;|', '', $variables['attributes_array']['style']);
    }
    if (!isset($elements['#attributes']['class'])) {
      $elements['#attributes']['class'] = array();
    }
    else if (!is_array($elements['#attributes']['class'])) {
      $elements['#attributes']['class'] = explode(' ', $elements['#attributes']['class']);
    }
    $variables['classes_array'] = array_merge($variables['classes_array'], $elements['#attributes']['class']);
  }
}

/**
 * Implement file_formatter_info_alter().
 */
function bangpoundmedia_file_formatter_info_alter(&$info) {

  // Remove the core Image formatter because File Entity module provides a better one.
  if (isset($info['file_image']) && isset($info['file_field_image'])) {
    unset($info['file_field_image']);
  }

  // The table formatter is useful for file fields with multiple values, but it is not
  // as useful for the file display because this is always a single value.
  if (isset($info['file_field_file_table'])) {
    unset($info['file_field_file_table']);
  }

  // Rendered file formatter is not useful for file displays.
  if (isset($info['file_field_file_rendered'])) {
    unset($info['file_field_file_rendered']);
  }

  if (isset($info['file_field_file_default'])) {
    $info['file_field_file_default']['description'] = t('An icon and the filename.');
  }

  if (isset($info['file_field_file_url_plain'])) {
    $info['file_field_file_url_plain']['description'] = t('Plain text URL.');
  }

  if (isset($info['file_field_media_large_icon'])) {
    $info['file_field_media_large_icon']['description'] = t('Reliable fallback for the <em>preview</em> view mode.');
  }
}

/**
 * Implements hook_ctools_plugin_api().
 */
function bangpoundmedia_ctools_plugin_api($module, $api) {
  if ($module == 'file_entity' && $api == 'file_default_displays') {
    return array('version' => 1);
  }
}

/**
 * Implement hook_form_FORMID_alter().
 *
 * This hides the large filetype icon formatter on preview view modes because it is always
 * enabled.
 *
 * @see bangpoundmedia_file_displays_alter().
 */
function bangpoundmedia_form_file_entity_file_display_form_alter(&$form, &$form_state) {
  $view_mode = $form_state['build_info']['args'][1];
  if ($view_mode == 'preview') {
    unset($form['displays']['status']['file_field_media_large_icon']);
    unset($form['displays']['order']['file_field_media_large_icon']);
  }
}
